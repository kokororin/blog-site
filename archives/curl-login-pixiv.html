<!doctype html>
<html class="han-la"><head><link rel=manifest href=/manifest.json><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/><meta name="renderer" content="webkit"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta name="theme-color" content="#16a085"/><meta name="description" content="模拟登录 pixiv.net"/><meta name="keywords" content="php,pixiv,curl"/><title>模拟登录 pixiv.net | あかね空</title><link rel="icon shortcut" type="image/ico" href="/favicon.ico"/><link rel="icon" href="/favicon.ico"/><link rel="stylesheet" href="/assets/app.css?v=775bb307e8087fad"/><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="あかね空" type="application/atom+xml">
</head><body><div id="pjax-container"><div id="main" class="container"><div id="main-post" role="main" itemscope="" itemType="http://schema.org/BlogPosting"><article class="post" style="padding-top:20px"><h2 itemProp="name headline" style="font-weight:normal">模拟登录 pixiv.net</h2><div class="text-right"><div class="text-bar"><a href="https://kotori.love" class="fui-home"></a><a href="#disqus_thread" class="fui-bubble" data-action="comment-go"></a><a style="font-size:30px;margin-left:1px">·</a><a href="https://twitter.com/intent/tweet?url=https://kotori.love/archives/curl-login-pixiv.html" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Twitter" class="fui-twitter"></a><a href="https://www.facebook.com/sharer/sharer.php?u=https://kotori.love/archives/curl-login-pixiv.html" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Facebook" class="fui-facebook"></a></div><div class="post-info"><span class="post-info-n"><a href="/categories/%E7%A7%91%E6%8A%80/">科技</a></span><a href="/tags/php/">php</a><a href="/tags/pixiv/">pixiv</a><a href="/tags/curl/">curl</a><a><time dateTime="2016-11-01T02:10:00.000Z">2016-11-01</time></a></div></div><div class="post-content" itemProp="articleBody"><p><strong>注意：本文的方法已作废，新方法在<a href="https://kotori.love/archives/curl-login-pixiv-next.html">这里</a></strong></p>
<blockquote>
<p>由于 pixivAPI 有一些内容无法获取，于是模拟登录就派上用场辣</p>
</blockquote>
<p>旧版登录接口 (<a href="https://www.secure.pixiv.net/login.php" target="_blank" rel="noopener">https://www.secure.pixiv.net/login.php</a>) 已经作废。目前新版登录页是用 React 渲染的，但是还是为老浏览器用户开启了兼容♂通道，首先找出这段表单代码：</p>
<pre><code class="language-html">&lt;div id=&quot;old-login&quot; style=&quot;display: none;&quot;&gt;
  &lt;form action=&quot;/login&quot; method=&quot;POST&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;post_key&quot; value=&quot;b827a089c8e7209503d23235d2ba4b43&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;return_to&quot; value=&quot;http://www.pixiv.net/&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;lang&quot; value=&quot;zh&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;source&quot; value=&quot;pc&quot;&gt;
    &lt;div class=&quot;input-field-group&quot;&gt;
      &lt;div class=&quot;input-field&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;pixiv_id&quot; placeholder=&quot;邮箱地址/pixiv ID&quot; autocapitalize=&quot;off&quot; autocomplete=&quot;off&quot;&gt;
      &lt;/div&gt;
      &lt;div class=&quot;input-field&quot;&gt;
        &lt;input type=&quot;password&quot; name=&quot;password&quot; placeholder=&quot;密码&quot; autocapitalize=&quot;off&quot; autocomplete=&quot;off&quot;&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;ul class=&quot;error-msg-list&quot;&gt;&lt;/ul&gt;
    &lt;button type=&quot;submit&quot; class=&quot;signup-form__submit&quot;&gt;登录&lt;/button&gt;
    &lt;div class=&quot;signup-form-nav&quot;&gt;
      &lt;div class=&quot;left&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;right&quot;&gt;&lt;a href=&quot;https://www.pixiv.net/reminder.php&quot; target=&quot;_blank&quot;&gt;忘记了&lt;/a&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/form&gt;
&lt;/div&gt;
</code></pre>
<p>发现需要 post 如下参数：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>post_key</td>
<td>类似于 token</td>
</tr>
<tr>
<td>return_to</td>
<td>回跳地址</td>
</tr>
<tr>
<td>lang</td>
<td>语言</td>
</tr>
<tr>
<td>source</td>
<td>来源</td>
</tr>
<tr>
<td>pixiv_id</td>
<td>用户名</td>
</tr>
<tr>
<td>password</td>
<td>密码</td>
</tr>
</tbody>
</table>
<p>提交的表单网址： <code>https://accounts.pixiv.net/login</code></p>
<p>因为有 token 的存在，所以提交的时候也需要登录页的生成的 cookie，不提交 cookie 的后果就是如下的 400 Bad Request：(/´Д｀)/<br/>
<img src="https://static-files.kotori.love/blog/2016/10/3972916762.png" alt=""/></p>
<p>下面直接上全宇宙最好的语言进行登录（啪）<br/>
需要注意，首先需要安装一个 HTML DOM 解析包 <code>sunra/php-simple-html-dom-parse</code> ，运行一下 <code>composer require &quot;sunra/php-simple-html-dom-parser&quot;</code>  就行了。</p>
<p>主要的代码：</p>
<pre><code>use Sunra\PhpSimple\HtmlDomParser;

define(&#x27;BEFORE_LOGIN_COOKIE&#x27;, __DIR__ . &#x27;/BEFORE_LOGIN_COOKIE.txt&#x27;);//登录页面的cookie
define(&#x27;AFTER_LOGIN_COOKIE&#x27;, __DIR__ . &#x27;/AFTER_LOGIN_COOKIE.txt&#x27;);//登录成功后获取到的cookie
define(&#x27;USER_AGENT&#x27;, &#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.59 Safari/537.36&#x27;);

function login_pixiv($username, $password)
{
    $login_url = &#x27;https://accounts.pixiv.net/login&#x27;;
    //获取登陆页cookie
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $login_url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_COOKIEJAR, BEFORE_LOGIN_COOKIE);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 15);
    curl_setopt($ch, CURLOPT_TIMEOUT, 15);
    curl_setopt($ch, CURLOPT_USERAGENT, USER_AGENT);

    $login_html = curl_exec($ch);

    curl_close($ch);

    $dom = HtmlDomParser::str_get_html($login_html);

    $form = $dom-&gt;find(&#x27;#old-login&#x27;, 0)-&gt;find(&#x27;form&#x27;, 0);

    $data[&#x27;post_key&#x27;] = $form-&gt;find(&#x27;input[name=&quot;post_key&quot;]&#x27;, 0)-&gt;value;
    $data[&#x27;return_to&#x27;] = $form-&gt;find(&#x27;input[name=&quot;return_to&quot;]&#x27;, 0)-&gt;value;
    $data[&#x27;lang&#x27;] = $form-&gt;find(&#x27;input[name=&quot;lang&quot;]&#x27;, 0)-&gt;value;
    $data[&#x27;source&#x27;] = $form-&gt;find(&#x27;input[name=&quot;source&quot;]&#x27;, 0)-&gt;value;
    $data[&#x27;pixiv_id&#x27;] = $username;
    $data[&#x27;password&#x27;] = $password;

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $login_url);
    curl_setopt($ch, CURLOPT_HEADER, 0);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_COOKIEFILE, BEFORE_LOGIN_COOKIE);
    curl_setopt($ch, CURLOPT_COOKIEJAR, AFTER_LOGIN_COOKIE);
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
    curl_exec($ch);
    curl_close($ch);
}
</code></pre>
<p>调用 <code>login_pixiv()</code>  方法登录成功获取到 cookie 后，就可以<strong>为♂所♂欲♂为</strong>了，这个 cookie 的有效期为一个月，提供一个验证 cookie 是否有效的方法：</p>
<pre><code>function is_cookie_ok($cookie)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, &#x27;http://www.pixiv.net/setting_profile.php&#x27;);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_HEADER, 1);
    curl_setopt($ch, CURLOPT_AUTOREFERER, 1);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 15);
    curl_setopt($ch, CURLOPT_TIMEOUT, 15);
    curl_setopt($ch, CURLOPT_USERAGENT, USER_AGENT);
    curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie);
    $response = curl_exec($ch);
    curl_close($ch);
    $headers = [];

    $header_text = substr($response, 0, strpos($response, &quot;\r\n\r\n&quot;));

    foreach (explode(&quot;\r\n&quot;, $header_text) as $i =&gt; $line) {
        if ($i === 0) {
            $headers[&#x27;http_code&#x27;] = $line;
        } else {
            list($key, $value) = explode(&#x27;: &#x27;, $line);

            $headers[$key] = $value;
        }
    }

    if (strpos($headers[&#x27;http_code&#x27;], &#x27;200&#x27;) === false) {
        return false;
    }
    return true;

}
</code></pre>
</div></article></div><center><div id="postnav"><ul class="pager"><li class="previous"><a href="https://kotori.love"><span class="fui-home"></span></a></li><li class="next" data-action="comment-show"><a href="#"><span class="fui-chat"></span></a></li><li class="previous"><a href="https://kotori.love/archives/react-js-pinterest-style-layout-site.html" title="react.js を利用して、創建した挿絵の画像欄">react.js を利用して、創建した挿絵の画像欄</a></li><li class="next"><a href="https://kotori.love/archives/backup-vps-to-git.html" title="备份服务器数据至 git">备份服务器数据至 git</a></li></ul></div></center><div id="disqus_thread" data-title="模拟登录 pixiv.net" data-permalink="https://kotori.love/archives/curl-login-pixiv.html"></div></div><footer id="footer" class="container" style="background:rgba(255, 255, 255, 0)"><hr/><div style="text-align:center;padding-bottom:9px"><p>© 2014 - 2020 <a href="https://kotori.love">あかね空</a>. Using <a target="_blank" href="https://hexo.io/">Hexo</a>  &amp; <a target="_blank" href="https://yumoe.com">Moricolor</a> / <a href="/atom.xml" data-nopjax="true">RSS</a></p></div></footer><script id="mori-json" type="text/json">{"bottomTools":{"hitokoto":true,"category":true,"tag":false,"search":true},"comment":{"use":"disqus","shortname":"sora-diary"},"analytics":{"use":"google","id":"UA-70944432-1"},"url":"https://kotori.love"}</script><script src="/assets/app.js?v=5f4e87ae9e29630a"></script></div></body></html>