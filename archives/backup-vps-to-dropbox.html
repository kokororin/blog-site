<!doctype html><html class="han-la"><head><link rel="manifest" href="/manifest.json"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#16a085"><meta name="description" content="将 VPS 备份到 Dropbox 的脚本"><meta name="keywords" content="vps,备份,dropbox"><title>将 VPS 备份到 Dropbox 的脚本 | あかねぞら</title><link rel="icon shortcut" type="image/ico" href="/favicon.ico"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kokororin/blog-site@master/assets/app.css?v=d57663896c0ae9f4"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="あかねぞら" type="application/atom+xml"></head><body><div id="pjax-container"><div id="main" class="container"><div id="main-post" role="main" itemscope="" itemtype="http://schema.org/BlogPosting"><article class="post" style="padding-top:20px"><h2 itemprop="name headline" style="font-weight:400">将 VPS 备份到 Dropbox 的脚本</h2><div class="text-right"><div class="text-bar"><a href="/" class="fui-home"></a><a href="#disqus_thread" class="fui-bubble" data-action="comment-go"></a><a style="font-size:30px;margin-left:1px">·</a><a href="https://twitter.com/intent/tweet?url=https://kotori.love/archives/backup-vps-to-dropbox.html" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Twitter" class="fui-twitter"></a><a href="https://www.facebook.com/sharer/sharer.php?u=https://kotori.love/archives/backup-vps-to-dropbox.html" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Facebook" class="fui-facebook"></a></div><div class="post-info"><span class="post-info-n"><a href="/categories/%E7%A7%91%E6%8A%80/">科技</a></span><a href="/tags/vps/">vps</a><a href="/tags/%E5%A4%87%E4%BB%BD/">备份</a><a href="/tags/dropbox/">dropbox</a><a><time datetime="2015-04-04T12:16:00.000Z">2015-04-04</time></a></div></div><div class="post-content" itemprop="articleBody"><p>首先，需要创建一个 Dropbox 应用，可以从该网址进行创建：<a href="https://www.dropbox.com/developers/apps/create" target="_blank" rel="noopener">https://www.dropbox.com/developers/apps/create</a>。</p><p>在这里，应用类型选择 Dropbox API App，数据存储类型选择 Files and datastores，权限选择 Yes（应用只需要访问它创建的文件）。然后命名创建。</p><p>下载 dropbox 备份脚本：</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># wget https://raw.github.com/andreafabrizi/Dropbox-Uploader/master/dropbox_uploader.sh</span>
</code></pre><p>然后，为该脚本添加执行权限：</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># chmod +x dropbox_uploader.sh</span>
</code></pre><p>执行该脚本：</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># ./dropbox_uploader.sh</span>
</code></pre><p>根据提示输入 Dropbox 应用中的 App key 和 App secret，许可类型选择 a，确认 y，复制给出的权限验证链接到浏览器，确认后回到终端按任意键完成。</p><p>编写定时备份脚本，<a href="http://xn--backup-vy7i169afoa.sh" target="_blank" rel="noopener">取名为 backup.sh</a>。其代码如下：</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#MYSQL数据库帐号密码</span>
<span class="token assign-left variable">MYSQL_USR</span><span class="token operator">=</span><span class="token string">&quot;root&quot;</span>  <span class="token comment"># 数据库帐号</span>
<span class="token assign-left variable">MYSQL_PWD</span><span class="token operator">=</span><span class="token string">&quot;password&quot;</span>  <span class="token comment"># 数据库密码</span>

<span class="token comment">#定义需要备份的目录</span>
<span class="token assign-left variable">NGINX_CONF_DIR</span><span class="token operator">=</span>/usr/local/nginx/conf  <span class="token comment"># nginx配置目录</span>
<span class="token assign-left variable">WEB_DIR</span><span class="token operator">=</span>/home/wwwroot  <span class="token comment"># 网站数据存放目录</span>

<span class="token comment">#定义备份存放目录</span>
<span class="token assign-left variable">DROPBOX_DIR</span><span class="token operator">=</span>/<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y-%m-%d<span class="token variable">)</span></span>  <span class="token comment"># Dropbox上的备份目录</span>
<span class="token assign-left variable">LOCAL_BAK_DIR</span><span class="token operator">=</span>/home/backup  <span class="token comment"># 本地备份文件存放目录</span>

<span class="token comment">#定义备份文件名称</span>
<span class="token assign-left variable">DBBakName</span><span class="token operator">=</span>DB_<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d<span class="token variable">)</span></span>.tar.gz
<span class="token assign-left variable">NginxConfBakName</span><span class="token operator">=</span>NginxConf_<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d<span class="token variable">)</span></span>.tar.gz
<span class="token assign-left variable">WebBakName</span><span class="token operator">=</span>Web_<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d<span class="token variable">)</span></span>.tar.gz

<span class="token comment">#定义旧数据名称</span>
<span class="token assign-left variable">Old_DROPBOX_DIR</span><span class="token operator">=</span>/<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> -d -7day +%Y-%m-%d<span class="token variable">)</span></span>
<span class="token assign-left variable">OldDBBakName</span><span class="token operator">=</span>DB_<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> -d -10day +%Y%m%d<span class="token variable">)</span></span>.tar.gz
<span class="token assign-left variable">OldNginxConfBakName</span><span class="token operator">=</span>NginxConf_<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> -d -10day +%Y%m%d<span class="token variable">)</span></span>.tar.gz
<span class="token assign-left variable">OldWebBakName</span><span class="token operator">=</span>Web_<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> -d -10day +%Y%m%d<span class="token variable">)</span></span>.tar.gz

<span class="token builtin class-name">cd</span> <span class="token variable">$LOCAL_BAK_DIR</span>

<span class="token comment">#使用命令导出SQL数据库,并且按数据库分个压缩</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">db</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span>mysql -u$MYSQL_USR -p$MYSQL_PWD -B -N -e <span class="token string">&#x27;SHOW DATABASES&#x27;</span> <span class="token operator">|</span> <span class="token function">xargs</span><span class="token variable">`</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token punctuation">(</span>/usr/local/mysql/bin/mysqldump -u<span class="token variable">$MYSQL_USR</span> -p<span class="token variable">$MYSQL_PWD</span> <span class="token variable">${db}</span> <span class="token operator">|</span> <span class="token function">gzip</span> -9 - <span class="token operator">&gt;</span>  <span class="token variable">${db}</span>.sql.gz<span class="token punctuation">)</span>
<span class="token keyword">done</span>

<span class="token comment">#压缩数据库文件合并为一个压缩文件</span>
<span class="token function">tar</span> zcf <span class="token variable">$LOCAL_BAK_DIR</span>/<span class="token variable">$DBBakName</span> <span class="token variable">$LOCAL_BAK_DIR</span>/*.sql.gz
<span class="token function">rm</span> -rf <span class="token variable">$LOCAL_BAK_DIR</span>/*.sql.gz

<span class="token comment">#压缩Nginx配置数据</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$NGINX_CONF_DIR</span>
<span class="token function">tar</span> zcf <span class="token variable">$LOCAL_BAK_DIR</span>/<span class="token variable">$NginxConfBakName</span> ./*

<span class="token comment">#压缩网站数据</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$WEB_DIR</span>
<span class="token function">tar</span> zcf <span class="token variable">$LOCAL_BAK_DIR</span>/<span class="token variable">$WebBakName</span> ./*

<span class="token builtin class-name">cd</span> /root/bin
<span class="token comment">#开始上传</span>
./dropbox_uploader.sh upload <span class="token variable">$LOCAL_BAK_DIR</span>/<span class="token variable">$DBBakName</span> <span class="token variable">$DROPBOX_DIR</span>/<span class="token variable">$DBBakName</span>
./dropbox_uploader.sh upload <span class="token variable">$LOCAL_BAK_DIR</span>/<span class="token variable">$NginxConfBakName</span> <span class="token variable">$DROPBOX_DIR</span>/<span class="token variable">$NginxConfBakName</span>
./dropbox_uploader.sh upload <span class="token variable">$LOCAL_BAK_DIR</span>/<span class="token variable">$WebBakName</span> <span class="token variable">$DROPBOX_DIR</span>/<span class="token variable">$WebBakName</span>

<span class="token comment">#删除旧数据</span>
<span class="token function">rm</span> -rf <span class="token variable">$LOCAL_BAK_DIR</span>/<span class="token variable">$OldDBBakName</span> <span class="token variable">$LOCAL_BAK_DIR</span>/<span class="token variable">$OldNginxConfBakName</span> <span class="token variable">$LOCAL_BAK_DIR</span>/<span class="token variable">$OldWebBakName</span>
./dropbox_uploader.sh delete <span class="token variable">$Old_DROPBOX_DIR</span>/

<span class="token builtin class-name">echo</span> -e <span class="token string">&quot;Backup Done!&quot;</span>
</code></pre><p>其中，用户可以根据自己的需求改编需要备份的目录，以及保留旧数据的时长（比如我这里设置的是 Dropbox 保留 7 天，本地保留 10 天）。</p><p>接下来，为这个备份脚本增加执行权限：</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># chmod +x backup.sh</span>
</code></pre><p>此处可以先测试一下能否备份成功：</p><p><img src="https://cdn.jsdelivr.net/gh/kokororin/static-files@master/blog/2015/04/2.jpg" alt="2"></p><p><img src="https://cdn.jsdelivr.net/gh/kokororin/static-files@master/blog/2015/04/3.jpg" alt="3"></p><p>crontab –e，添加：</p><pre><code>30 3 * * * /root/bin/backup.sh
</code></pre><p>这样，就可以每天凌晨 3：30 自动备份到 Dropbox 了。</p><blockquote><p>本文参考自：<a href="http://www.pythoner.com/324.html" target="_blank" rel="noopener">http://www.pythoner.com/324.html</a></p></blockquote></div></article></div><center><div id="postnav"><ul class="pager"><li class="previous"><a href="/"><span class="fui-home"></span></a></li><li class="next" data-action="comment-show"><a href="#"><span class="fui-chat"></span></a></li><li class="previous"><a href="/archives/typecho-theme-tips.html" title="Typecho 主题制作总结">Typecho 主题制作总结</a></li><li class="next"><a href="/archives/successfully-installed-black-apple.html" title="成功安装黑苹果 发此文以纪念">成功安装黑苹果 发此文以纪念</a></li></ul></div></center><div id="valine-comments" style="display:none"></div><div class="post-tor-content"><div class="post-tor" id="postTor"><div class="torarc-t"><div class="torarc-tile"></div></div></div></div></div><footer id="footer" class="container" style="background:rgba(255,255,255,0)"><hr><div style="text-align:center;padding-bottom:9px"><p>© 2014 - 2020 <a href="/">あかねぞら</a>. Using <a target="_blank" href="https://hexo.io/">Hexo</a>  &amp; <a target="_blank" href="https://yumoe.com">Moricolor</a> / <a href="/atom.xml" data-nopjax="true">RSS</a></p></div></footer><script id="mori-json" type="text/json">{"bottomTools":{"hitokoto":true,"category":true,"tag":false,"page":true,"search":true},"style":{"color":{"enabled":false,"colors":["#f48fb1","#f48fb1","#f8bbd0"]}},"comment":{"use":"valine","appId":"ikbNNOUhw2U2KuYFXgcfb9GP-MdYXbMMI","appKey":"ggySdQdQ8EC21u2PXS8iOQNp"},"github":"https://github.com/kokororin","analytics":{"use":"google","id":"UA-70944432-1"},"sentry":{"dsn":"https://7bdda1be9b094ef0b6ff3c364024537c@sentry.io/2406563"}}</script><script src="https://cdn.jsdelivr.net/gh/kokororin/blog-site@master/assets/app.js?v=bdf16e2445312366"></script></div></body></html>