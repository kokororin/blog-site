<!doctype html>
<html class="han-la"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/><meta name="renderer" content="webkit"/><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/><meta name="theme-color" content="#16a085"/><title>将 VPS 备份到 Dropbox 的脚本 | ことりのおやつにしてやるぞー！</title><link rel="icon shortcut" type="image/ico" href="/favicon.ico"/><link rel="icon" href="/favicon.ico"/><link rel="stylesheet" href="/assets/app.css?v=8f16cadb70231219"/><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="ことりのおやつにしてやるぞー！" type="application/atom+xml">
</head><body><div id="pjax-container"><div id="main" class="container"><div id="main-post" role="main" itemscope="" itemType="http://schema.org/BlogPosting"><article class="post" style="padding-top:20px"><h2 itemProp="name headline" style="font-weight:normal">将 VPS 备份到 Dropbox 的脚本</h2><div class="text-right"><div class="text-bar"><a href="https://kotori.love" class="fui-home"></a><a href="#disqus_thread" class="fui-bubble" data-action="comment-go"></a><a style="font-size:30px;margin-left:1px">·</a><a href="https://twitter.com/intent/tweet?url=https://kotori.love/archives/backup-vps-to-dropbox.html" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Twitter" class="fui-twitter"></a><a href="https://www.facebook.com/sharer/sharer.php?u=https://kotori.love/archives/backup-vps-to-dropbox.html" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Facebook" class="fui-facebook"></a></div><div class="post-info"><span class="post-info-n"><a href="/categories/%E7%A7%91%E6%8A%80/">科技</a></span><a href="/tags/vps/">vps</a><a href="/tags/%E5%A4%87%E4%BB%BD/">备份</a><a href="/tags/dropbox/">dropbox</a><a><time dateTime="2015-04-04T12:16:00.000Z">2015-04-04</time></a></div></div><div class="post-content" itemProp="articleBody"><p>首先，需要创建一个 Dropbox 应用，可以从该网址进行创建：<a href="https://www.dropbox.com/developers/apps/create" target="_blank" rel="noopener">https://www.dropbox.com/developers/apps/create</a>。</p>
<p>在这里，应用类型选择 Dropbox API App，数据存储类型选择 Files and datastores，权限选择 Yes（应用只需要访问它创建的文件）。然后命名创建。</p>
<p>下载 dropbox 备份脚本：</p>
<pre><code class="language-bash"># wget https://raw.github.com/andreafabrizi/Dropbox-Uploader/master/dropbox_uploader.sh
</code></pre>
<p>然后，为该脚本添加执行权限：</p>
<pre><code class="language-bash"># chmod +x dropbox_uploader.sh
</code></pre>
<p>执行该脚本：</p>
<pre><code class="language-bash"># ./dropbox_uploader.sh
</code></pre>
<p>根据提示输入 Dropbox 应用中的 App key 和 App secret，许可类型选择 a，确认 y，复制给出的权限验证链接到浏览器，确认后回到终端按任意键完成。</p>
<p>编写定时备份脚本，<a href="http://xn--backup-vy7i169afoa.sh" target="_blank" rel="noopener">取名为 backup.sh</a>。其代码如下：</p>
<pre><code class="language-bash">#!/bin/bash
#MYSQL数据库帐号密码
MYSQL_USR=&quot;root&quot;  # 数据库帐号
MYSQL_PWD=&quot;password&quot;  # 数据库密码

#定义需要备份的目录
NGINX_CONF_DIR=/usr/local/nginx/conf  # nginx配置目录
WEB_DIR=/home/wwwroot  # 网站数据存放目录

#定义备份存放目录
DROPBOX_DIR=/$(date +%Y-%m-%d)  # Dropbox上的备份目录
LOCAL_BAK_DIR=/home/backup  # 本地备份文件存放目录

#定义备份文件名称
DBBakName=DB_$(date +%Y%m%d).tar.gz
NginxConfBakName=NginxConf_$(date +%Y%m%d).tar.gz
WebBakName=Web_$(date +%Y%m%d).tar.gz

#定义旧数据名称
Old_DROPBOX_DIR=/$(date -d -7day +%Y-%m-%d)
OldDBBakName=DB_$(date -d -10day +%Y%m%d).tar.gz
OldNginxConfBakName=NginxConf_$(date -d -10day +%Y%m%d).tar.gz
OldWebBakName=Web_$(date -d -10day +%Y%m%d).tar.gz

cd $LOCAL_BAK_DIR

#使用命令导出SQL数据库,并且按数据库分个压缩
for db in `mysql -u$MYSQL_USR -p$MYSQL_PWD -B -N -e &#x27;SHOW DATABASES&#x27; | xargs`; do
    (/usr/local/mysql/bin/mysqldump -u$MYSQL_USR -p$MYSQL_PWD ${db} | gzip -9 - &gt;  ${db}.sql.gz)
done

#压缩数据库文件合并为一个压缩文件
tar zcf $LOCAL_BAK_DIR/$DBBakName $LOCAL_BAK_DIR/*.sql.gz
rm -rf $LOCAL_BAK_DIR/*.sql.gz

#压缩Nginx配置数据
cd $NGINX_CONF_DIR
tar zcf $LOCAL_BAK_DIR/$NginxConfBakName ./*

#压缩网站数据
cd $WEB_DIR
tar zcf $LOCAL_BAK_DIR/$WebBakName ./*

cd /root/bin
#开始上传
./dropbox_uploader.sh upload $LOCAL_BAK_DIR/$DBBakName $DROPBOX_DIR/$DBBakName
./dropbox_uploader.sh upload $LOCAL_BAK_DIR/$NginxConfBakName $DROPBOX_DIR/$NginxConfBakName
./dropbox_uploader.sh upload $LOCAL_BAK_DIR/$WebBakName $DROPBOX_DIR/$WebBakName

#删除旧数据
rm -rf $LOCAL_BAK_DIR/$OldDBBakName $LOCAL_BAK_DIR/$OldNginxConfBakName $LOCAL_BAK_DIR/$OldWebBakName
./dropbox_uploader.sh delete $Old_DROPBOX_DIR/

echo -e &quot;Backup Done!&quot;
</code></pre>
<p>其中，用户可以根据自己的需求改编需要备份的目录，以及保留旧数据的时长（比如我这里设置的是 Dropbox 保留 7 天，本地保留 10 天）。</p>
<p>接下来，为这个备份脚本增加执行权限：</p>
<pre><code class="language-bash"># chmod +x backup.sh
</code></pre>
<p>此处可以先测试一下能否备份成功：</p>
<p><img src="https://static-files.kotori.love/blog/2015/04/2.jpg" alt="2"/></p>
<p><img src="https://static-files.kotori.love/blog/2015/04/3.jpg" alt="3"/></p>
<p>crontab –e，添加：</p>
<pre><code>30 3 * * * /root/bin/backup.sh
</code></pre>
<p>这样，就可以每天凌晨 3：30 自动备份到 Dropbox 了。</p>
<blockquote>
<p>本文参考自：<a href="http://www.pythoner.com/324.html" target="_blank" rel="noopener">http://www.pythoner.com/324.html</a></p>
</blockquote>
</div></article></div><center><div id="postnav"><ul class="pager"><li class="previous"><a href="https://kotori.love"><span class="fui-home"></span></a></li><li class="next" data-action="comment-show"><a href="#"><span class="fui-chat"></span></a></li><li class="previous"><a href="https://kotori.love/archives/public-dns-hellodns.html" title="HelloDNS 公共 DNS">HelloDNS 公共 DNS</a></li><li class="next"><a href="https://kotori.love/archives/successfully-installed-black-apple.html" title="成功安装黑苹果 发此文以纪念">成功安装黑苹果 发此文以纪念</a></li></ul></div></center><div id="disqus_thread" style="display:none" data-title="将 VPS 备份到 Dropbox 的脚本" data-permalink="https://kotori.love/archives/backup-vps-to-dropbox.html"></div></div><footer id="footer" class="container" style="background:rgba(255, 255, 255, 0)"><hr/><div style="text-align:center;padding-bottom:9px"><p>© 2015 - 2020 <a href="https://kotori.love">ことりのおやつにしてやるぞー！</a>. Using <a target="_blank" href="https://hexo.io/">Hexo</a>  &amp; <a target="_blank" href="https://yumoe.com">Moricolor</a> / <a href="/atom.xml" data-nopjax="true">RSS</a></p></div></footer><script id="mori-json" type="text/json">{"bottomTools":{"hitokoto":true,"category":true,"tag":false,"search":true},"comment":{"use":"disqus","shortname":"sora-diary"},"analytics":{"use":"google","id":"UA-70944432-1"},"url":"https://kotori.love"}</script><script src="/assets/app.js?v=4d4ce1c9f3bb6a3e"></script></div></body></html>