<!DOCTYPE html>
<html class="han-la">
  <head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#16a085">
  
  
  
  <title>Typecho 主题制作总结 | ことりのおやつにしてやるぞー！</title>

  
  <link rel="icon shortcut" type="image/ico" href="/favicon.ico">
  <link rel="icon" href="/favicon.ico">


  
  
<link rel="stylesheet" href="/css/mori.css">

  
<link rel="stylesheet" href="/css/bootstrap.min.css">

  
<link rel="stylesheet" href="/css/flat-ui.min.css">

  
<link rel="stylesheet" href="/css/prism.css">

  
<link rel="stylesheet" href="/css/nprogress.css">

  
<link rel="stylesheet" href="/fonts/material-design-iconic-font.min.css">


  
  
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="ことりのおやつにしてやるぞー！" type="application/atom+xml">
</head>

<body>
  

  <div id="pjax-container">
    <div id="main" class="container">
  <div id="main-post" role="main" itemscope itemtype="http://schema.org/BlogPosting" style="display:none">
    <article class="post" style="padding-top:20px">
      <h2 itemprop="name headline" style="font-weight:400">Typecho 主题制作总结</h2>
      <div class="text-right">
        <div class="text-bar">
          <a href="https://kotori.love" class="fui-home"></a>
          
          <a href="#disqus_thread" class="fui-bubble" data-action="comment-go"></a>
          <a style="font-size:30px;margin-left:1px">·</a>
          <a href="https://twitter.com/intent/tweet?url=https://kotori.love/archives/typecho-theme-tips.html" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Twitter" class="fui-twitter"></a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://kotori.love/archives/typecho-theme-tips.html" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Facebook" class="fui-facebook"></a>
          <a href="https://plus.google.com/share?url=https://kotori.love/archives/typecho-theme-tips.html" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Google+" class="fui-google-plus"></a>
          <a href="http://service.weibo.com/share/share.php?url=https://kotori.love/archives/typecho-theme-tips.html&title=Typecho 主题制作总结" target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Weibo" class="fui-bookmark"></a>
        </div>
        <div class="post-info">
          <span class="post-info-n">
            
              <a href="/categories/%E7%A7%91%E6%8A%80/">科技</a>
            
          </span>
          
            <a href="/tags/typecho/">typecho</a>
          
            <a href="/tags/%E4%B8%BB%E9%A2%98/">主题</a>
          
          <a><time datetime="2015-07-05T04:53:00.000Z">2015-07-05</time></a>
        </div>
      </div>
      
      
      <div class="post-content" itemprop="articleBody">
        <p>由于 Typecho 相比 WordPress，所提供的接口较少，所以有些地方需要注意下。</p>
<h3 id="首页文章无限加载文章">首页文章无限加载文章</h3>
<p>首先在 functions.php 中加入一段判断 ajax 请求的方法：</p>
<pre><code class="language-php">function is_ajax()
{
    if (isset($_SERVER['HTTP_X_REQUESTED_WITH'])) {
        if ('xmlhttprequest' == strtolower($_SERVER['HTTP_X_REQUESTED_WITH'])) {
            return true;
        }
    }
    return false;
}
</code></pre>
<p>然后在首页模板 index.php 中加入判断，if (is_ajax ()): 则不输出 header footer 等信息。<br>
最后一步，再模板公共 js 文件中加入以下代码：</p>
<pre><code class="language-javascript">    var page = 1;
    var $body = (window.opera) ? (document.compatMode == &quot;CSS1Compat&quot; ? $('html') : $('body')) : $('html,body');
    $('#blog_load_more').click(function(event) {
        $(this).hide();
        $('#spinner').show();
        $.ajax({
            type: 'get',
            url: SITE.default_url + '/page/' + parseInt(page + 1),
            success: function(data, textStatus, XMLHttpRequest) {
                page++;
                $('.w-blog-list').append(data);
                $('#spinner').hide();
                $('#blog_load_more').show();
            },
            error: function(MLHttpRequest, textStatus, errorThrown) {
                $('#spinner').hide();
                $.jGrowl('Network Error');
            }
        });
    });
</code></pre>
<p>其中 #blog_load_more 为需要绑定的加载更多按钮，#spinner 为加载过程中的动画，.w-blog-list 为首页文章列表容器。<br>
由于 Typecho 并没有 Ajax 钩子函数，所以需要在 functions.php 中加入以下代码：</p>
<pre><code class="language-php">function site_data()
{
    $array = array(
        'site_url'         =&gt; Helper::options()-&gt;siteUrl,
        'default_url'      =&gt; Helper::options()-&gt;siteUrl . 'index.php',
        'theme_images_url' =&gt; Helper::options()-&gt;themeUrl . '/assets/images/',
    );
    echo json_encode($array);
}
</code></pre>
<p>之后在 footer.php 中引入该数据：</p>
<pre><code class="language-html">&lt;script type=&quot;text/javascript&quot;&gt;
var SITE = &lt;?php site_data()?&gt;;
&lt;/script&gt;
</code></pre>
<p>此处的 SITE 就是一个 JSON 对象，可以直接用了。</p>
<h3 id="WordPress的add-filter很好用，Typecho也可以实现类似的功能：">WordPress 的 add_filter 很好用，Typecho 也可以实现类似的功能：</h3>
<p>比如想把文章中的图片都加上 rel=&quot;fancybox&quot; 的属性，WordPress 可能使用的以下方法：</p>
<pre><code class="language-php">add_filter('the_content', 'fancybox_replace');
function fancybox_replace($content)
{
    global $post;
    $pattern     = &quot;/&lt;a(.*?)href=('|\&quot;)([^&gt;]*).(bmp|gif|jpeg|jpg|png)('|\&quot;)(.*?)&gt;(.*?)&lt;\/a&gt;/i&quot;;
    $replacement = '&lt;a$1href=$2$3.$4$5 target=&quot;_blank&quot; rel=&quot;fancybox&quot;$6&gt;$7&lt;/a&gt;';
    $content     = preg_replace($pattern, $replacement, $content);
    return $content;
}
</code></pre>
<p>Typecho 中可以这么写：</p>
<pre><code class="language-php">function themeInit($archive)
{
    if ($archive-&gt;is('single')) {
        $archive-&gt;content = fancybox_replace($archive-&gt;content);
    }

}
</code></pre>
<h3 id="获取文章第一张图片">获取文章第一张图片</h3>
<p>分为 markdown 和 html 两种方式</p>
<pre><code class="language-php">function get_post_img($archive)
{
    $cid = $archive-&gt;cid;
    $db = Typecho_Db::get();
    $rs = $db-&gt;fetchRow($db-&gt;select('table.contents.text')
                               -&gt;from('table.contents')
                               -&gt;where('cid=?', $cid));
    $text = $rs['text'];
    if (0 === strpos($text, '')) {
        preg_match('/!\[[^\]]*]\([^\)]*\.(png|jpeg|jpg|gif|bmp)\)/i', $text, $img);
        if (empty($img)) {
            return 'none';
        } else {
            preg_match(&quot;/(?:\()(.*)(?:\))/i&quot;, $img[0], $result);
            $img_url = $result[1];
            return '&lt;img src=&quot;' . $img_url . '&quot;/&gt;';
        }
    } else {
        preg_match_all(&quot;/\&lt;img.*?src\=\&quot;(.*?)\&quot;[^&gt;]*&gt;/i&quot;, $text, $img);
        if (empty($img)) {
            return 'none';
        } else {
            $img_url = $img[1][0];
            return '&lt;img src=&quot;' . $img_url . '&quot;/&gt;';
        }
    }
}
</code></pre>
<h3 id="评论列表加">评论列表加 @</h3>
<pre><code class="language-php">function get_comment_at($coid)
{
    $db   = Typecho_Db::get();
    $prow = $db-&gt;fetchRow($db-&gt;select('parent')-&gt;from('table.comments')
                                 -&gt;where('coid = ? AND status = ?', $coid, 'approved'));
    $parent = $prow['parent'];
    if ($parent != &quot;0&quot;) {
        $arow = $db-&gt;fetchRow($db-&gt;select('author')-&gt;from('table.comments')
                                     -&gt;where('coid = ? AND status = ?', $parent, 'approved'));
        $author = $arow['author'];
        $href   = '&lt;a href=&quot;#comment-' . $parent . '&quot;&gt;@' . $author . '&lt;/a&gt;';
        echo $href;
    } else {
        echo '';
    }

}
</code></pre>
<h3 id="非插件实现文章阅读次数统计">非插件实现文章阅读次数统计</h3>
<p>在文章页面引入 get_post_view () 方法。</p>
<pre><code class="language-php">//get_post_view($this)
function get_post_view($archive)
{
    $cid    = $archive-&gt;cid;
    $db     = Typecho_Db::get();
    $prefix = $db-&gt;getPrefix();
    if (!array_key_exists('views', $db-&gt;fetchRow($db-&gt;select()-&gt;from('table.contents')))) {
        $db-&gt;query('ALTER TABLE `' . $prefix . 'contents` ADD `views` INT(10) DEFAULT 0;');
        echo 0;
        return;
    }
    $row = $db-&gt;fetchRow($db-&gt;select('views')-&gt;from('table.contents')-&gt;where('cid = ?', $cid));
    if ($archive-&gt;is('single')) {
       $db-&gt;query($db-&gt;update('table.contents')-&gt;rows(array('views' =&gt; (int) $row['views'] + 1))-&gt;where('cid = ?', $cid));
    }
    echo $row['views'];
}
</code></pre>
<h3 id="判断移动端访问">判断移动端访问</h3>
<pre><code class="language-php">function is_mobile()
{
    $user_agent     = $_SERVER['HTTP_USER_AGENT'];
    $mobile_browser = array(
        &quot;mqqbrowser&quot;, //手机QQ浏览器
        &quot;opera mobi&quot;, //手机opera
        &quot;juc&quot;, &quot;iuc&quot;, //uc浏览器
        &quot;fennec&quot;, &quot;ios&quot;, &quot;applewebKit/420&quot;, &quot;applewebkit/525&quot;, &quot;applewebkit/532&quot;, &quot;ipad&quot;, &quot;iphone&quot;, &quot;ipaq&quot;, &quot;ipod&quot;,
        &quot;iemobile&quot;, &quot;windows ce&quot;, //windows phone
        &quot;240x320&quot;, &quot;480x640&quot;, &quot;acer&quot;, &quot;android&quot;, &quot;anywhereyougo.com&quot;, &quot;asus&quot;, &quot;audio&quot;, &quot;blackberry&quot;,
        &quot;blazer&quot;, &quot;coolpad&quot;, &quot;dopod&quot;, &quot;etouch&quot;, &quot;hitachi&quot;, &quot;htc&quot;, &quot;huawei&quot;, &quot;jbrowser&quot;, &quot;lenovo&quot;,
        &quot;lg&quot;, &quot;lg-&quot;, &quot;lge-&quot;, &quot;lge&quot;, &quot;mobi&quot;, &quot;moto&quot;, &quot;nokia&quot;, &quot;phone&quot;, &quot;samsung&quot;, &quot;sony&quot;,
        &quot;symbian&quot;, &quot;tablet&quot;, &quot;tianyu&quot;, &quot;wap&quot;, &quot;xda&quot;, &quot;xde&quot;, &quot;zte&quot;,
    );
    $is_mobile = false;
    foreach ($mobile_browser as $device) {
        if (stristr($user_agent, $device)) {
            $is_mobile = true;
            break;
        }
    }
    return $is_mobile;
}
</code></pre>
<h3 id="ajax评论">ajax 评论</h3>
<p>AjaxComments 有小 bug，不太好用，直接食用以下的修改版代码，在公共 js 中调用 ajaxComments () 方法即可</p>
<pre><code class="language-javascript">function ajaxComment() {
    var selector = {
        commentMainFrame: '#comment',
        commentList: '#commentlist',
        commentNumText: '#comment h3',
        commentReplyButton: '#comment span.reply',
        submitForm: '#commentform',
        submitTextarea: '#textarea',
        submitButton: '#submit',
    };
    var parentId = '';
    bindCommentReplyButton();
    $(selector.submitTextarea).after('&lt;div style=&quot;display:none;&quot; id=&quot;ajaxCommentMsg&quot;&gt;&lt;\/div&gt;');
    $msg = $('#ajaxCommentMsg');
    $(document).on('submit', selector.submitForm, function() {
        $msg.empty();
        $(selector.submitButton).val('发射中哦=A=');
        $(selector.submitButton).attr('disabled', true).fadeTo('slow', 0.5);
        if ($(selector.submitForm).find('#author')[0]) {
            if ($(selector.submitForm).find('#author').val() == '') {
                message('昵称没填呢QAQ');
                enableCommentButton();
                return false;
            }
            if ($(selector.submitForm).find('#mail').val() == '') {
                message('邮箱没填呢QAQ');
                enableCommentButton();
                return false;
            }
            var filter = /^[^@\s&lt;&amp;&gt;]+@([a-z0-9]+\.)+[a-z]{2,4}$/i;
            if (!filter.test($(selector.submitForm).find('#mail').val())) {
                message('邮箱地址不正确呢QAQ');
                enableCommentButton();
                return false;
            }
        }
        if ($(selector.submitForm).find(selector.submitTextarea).val() == '') {
            message('评论似乎什么也没写呢QAQ');
            enableCommentButton();
            return false;
        }
        $.ajax({
            url: $(this).attr('action'),
            type: $(this).attr('method'),
            data: $(this).serializeArray(),
            error: function() {
                message('发射失败,请重试!');
                setTimeout(NProgress.done, 500)
                enableCommentButton();
                return false;
            },
            success: function(data) {
                if (!$(selector.commentList, data).length) {
                    errorMsg = data.match(/.+/g).join().match(/\&lt;div.+\&gt;.+\&lt;\/div\&gt;/g).join().match(/[^\,]+/g);
                    $msg.html(errorMsg[0] + errorMsg[1] + errorMsg[2]);
                    enableCommentButton();
                    return false;
                } else {
                    userCommentId = $(selector.commentList, data).html().match(/id=\&quot;?comment-\d+/g).join().match(/\d+/g).sort(function(a, b) {
                        return a - b;
                    }).pop();
                    commentLi = '&lt;li id=&quot;comment-' + userCommentId + '&quot; class=&quot;comment&quot;&gt;' + $('#comment-' + userCommentId, data).html(); + '&lt;\/li&gt;';
                    if (parentId) {
                        if ($('#' + parentId).find(&quot;.comment-children&quot;).length &lt;= 0) {
                            $('#' + parentId).append(&quot;&lt;ul class='children'&gt;&lt;/ul&gt;&quot;);
                        }
                        $('#' + parentId + &quot; .children:first&quot;).append(commentLi);
                        parentId = ''
                        $body.animate({
                            scrollTop: $('#comment-' + userCommentId).offset().top - 450
                        }, 900);
                    } else {
                        $(selector.commentList).prepend(commentLi)
                        $body.animate({
                            scrollTop: $('#comment-' + userCommentId).offset().top - 200
                        }, 900);
                    }
                    //$('#comment-' + userCommentId).slideDown('slow');

                    //console.log(userCommentId);
                    $(selector.commentNumText).length ? (n = parseInt($(selector.commentNumText).text().match(/\d+/)), $(selector.commentNumText).html($(selector.commentNumText).html().replace(n, n + 1))) : 0;
                    TypechoComment.cancelReply();
                    $(selector.submitTextarea).val('');
                    $(selector.commentReplyButton + ' b, #cancel-comment-reply-link').unbind('click');
                    bindCommentReplyButton();
                    enableCommentButton();

                }
            }
        });
        return false;
    });

    function bindCommentReplyButton() {
        $(document).on('click', selector.commentReplyButton, function() {
            parentId = $(this).parents('li.comment').attr(&quot;id&quot;);
            $(selector.submitTextarea).focus();
        });
        $(document).on('click', '#cancel-comment-reply-link', function() {
            parentId = '';
        });
    }

    function enableCommentButton() {
        $(selector.submitButton).attr('disabled', false).fadeTo('', 1);
        $(selector.submitButton).val('发射=A=');
    }

    function message(msg) {
        $msg.hide();
        $msg.html(msg).slideToggle('fast');
    }
}

</code></pre>
<h3 id="无限嵌套评论">无限嵌套评论</h3>
<pre><code class="language-php">function themeInit($archive)
{
    Helper::options()-&gt;commentsMaxNestingLevels = 999;
}
</code></pre>
<h3 id="非插件实现路由">非插件实现路由</h3>
<pre><code class="language-php">function themeInit($archive)
{
    if ($archive-&gt;is('archive', 404))
    {
        $path_info = trim($archive-&gt;request-&gt;getPathinfo(), '/');
        if ($path_info == 'i/redirect')
        {
            $url = urldecode($archive-&gt;request-&gt;url);
            $archive-&gt;response-&gt;redirect($url);
            exit;
        }
    }
}
</code></pre>

      </div>
    </article>
  </div>

  <center>
    <div id="postnav" style="display:none">
      <ul class="pager">
        <li class="previous">
          <a href="https://kotori.love">
            <span class="fui-home"></span>
          </a>
        </li>
        <li class="next" data-action="comment-show">
          <a href="javascript:void(0)">
            <span class="fui-chat"></span>
          </a>
        </li>

        <li class="previous">
          
            <a href="https://kotori.love/archives/fetch-gravatar-with-php.html" title="简单使用 php 获取 gravatar 头像">简单使用 php 获取 gravatar 头像</a>
          
        </li>

        <li class="next">
          
            <a href="https://kotori.love/archives/public-dns-hellodns.html" title="HelloDNS 公共 DNS">HelloDNS 公共 DNS</a>
          
        </li>
      </ul>
    </div>
  </center>

  <div id="disqus_thread" data-title="Typecho 主题制作总结" data-permalink="https://kotori.love/archives/typecho-theme-tips.html" data-allow-comment=""></div>

  

</div>

  </div>
  <footer id="footer" class="container" style="background:rgba(255,255,255,0);display:none">
  <hr>
  <div style="text-align:center;padding-bottom:9px">
    <p>&copy; 2020 <a href="https://kotori.love">ことりのおやつにしてやるぞー！</a>.
      Using <a target="_blank" href="https://hexo.io/">Hexo</a> & <a target="_blank" href="https://yumoe.com">Moricolor</a>
      / <a href="/atom.xml" data-nopjax>RSS</a>
  </p></div>
</footer>

<script>window.moriVars={bottomTools:{hitokoto:!0,category:!0,tag:!1,search:!0},comment:{use:"disqus",shortname:"sora-diary"},analytics:{use:"google",id:"UA-70944432-1"},url:"https://kotori.love"}</script>


<script src="/js/jquery.min.js"></script>


<script src="/js/bootstrap.js"></script>


<script src="/js/flat-ui.min.js"></script>


<script src="/js/prism.js"></script>


<script src="/js/pjax.js"></script>


<script src="/js/nprogress.js"></script>


<script src="/js/mori.js"></script>



  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-70944432-1"></script>
  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-70944432-1")</script>


</body>
</html>
