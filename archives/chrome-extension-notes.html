<!DOCTYPE html>
<html class="han-la">
  <head>
    <meta charset="utf-8">
    <!-- Meta & Title & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="theme-color" content="#16a085">
<!-- Blue #448AFF -->
<!-- Title -->

<title>Chrome扩展开发笔记 | ことりのおやつにしてやるぞー！</title>

<!-- Favicons -->
<link rel="icon shortcut" type="image/ico" href="/favicon.ico">
<link rel="icon" href="/favicon.ico">


    <!-- Import CSS -->
    
<link rel="stylesheet" href="/css/mori.css">

    
<link rel="stylesheet" href="/css/vendor/bootstrap/css/bootstrap.min.css">

    
<link rel="stylesheet" href="/css/flat-ui.min.css">

    
<link rel="stylesheet" href="/css/prism.css">

    
<link rel="stylesheet" href="/fonts/md/css/material-design-iconic-font.min.css">

    
<link rel="stylesheet" href="/js/zoom-js/css/zoom.css">


    <!-- RSS -->
    


<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="ことりのおやつにしてやるぞー！" type="application/atom+xml">
</head>

<body>
  

  <div id="main" class="container">
  <div id="main-post" role="main" itemscope itemtype="http://schema.org/BlogPosting" style="display: none;">
    <article class="post" style="padding-top: 20px;">
      <h2 itemprop="name headline" style="font-weight: normal;">Chrome扩展开发笔记</h2>
      <div class="text-right">
        <div class="text-bar">
          <a href="http://kotori.love" class="fui-home"></a>
          <!-- <a id="tor_show" href="javascript:void(0)" class="fui-list-bulleted"></a> -->
          <a id="comment_go" href="#comments" class="fui-bubble"></a>
          <a style="font-size: 30px;margin-left: 1px;">·</a>
          <a href="https://twitter.com/intent/tweet?url=http://kotori.love/archives/chrome-extension-notes.html" target="_blank" rel="nofollow"
            data-placement="bottom" data-toggle="tooltip" title="Twitter" class="fui-twitter"></a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=http://kotori.love/archives/chrome-extension-notes.html" target="_blank" rel="nofollow"
            data-placement="bottom" data-toggle="tooltip" title="Facebook" class="fui-facebook"></a>
          <a href="https://plus.google.com/share?url=http://kotori.love/archives/chrome-extension-notes.html" target="_blank" rel="nofollow"
            data-placement="bottom" data-toggle="tooltip" title="Google+" class="fui-google-plus"></a>
          <a href="http://service.weibo.com/share/share.php?url=http://kotori.love/archives/chrome-extension-notes.html&title=Chrome扩展开发笔记"
            target="_blank" rel="nofollow" data-placement="bottom" data-toggle="tooltip" title="Weibo"
            class="fui-bookmark"></a>
        </div>
        <div class="post-info">
          <span class="post-info-n">
            
            <a href="/categories/%E7%A7%91%E6%8A%80/">科技</a>
            
          </span>
          
          <a href="/tags/chrome/">chrome</a>
          
          <a><time datetime="2015-10-06T12:37:00.000Z">2015-10-06</time></a>
        </div>
      </div>
      <!-- 头图 -->
      <!-- end -->
      <div class="post-content" itemprop="articleBody">
        <blockquote>
<p>今天研究了一下Chrome扩展的基本结构，尝试着开发了一款音乐播放器(Kotori Music Player)。随便记点东西。</p>
</blockquote>
<p>先看看这个拓展的效果，如下图:</p>
<p><img src="https://static-files.kotori.love/blog/2015/10/2407146113.png" alt="EC25D950-E3CB-4BE5-ACF8-EF7C1843BAA4.png"></p>
<p><img src="https://static-files.kotori.love/blog/2015/10/1859953824.png" alt="216C02A1-A210-4032-8214-CF0433421D0E.png"></p>
<h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><p>Chrome扩展都包含一个Manifest文件——manifest.json，这个文件可以告诉Chrome关于这个扩展的相关信息，它是整个扩展的入口，也是Chrome扩展必不可少的部分。 Chrome扩展的Manifest文件必须包含name、version和manifest_version属性，目前来说manifest_version属性值只能为数字2，对于应用来说，还必须包含app属性。</p>
<p>其他常用的可选属性还有browser_action、page_action、background、permissions、options_page、content_scripts，所以我们可以保留一份manifest.json模板，当编写新的扩展时直接填入相应的属性值。如果我们需要的属性不在这个模板中，可以再去查阅官方文档，但我想这样的一份模板可以应对大部分的扩展了。下面就放上Kotori Music Player的manifest.json文件模板：</p>
<figure class="highlight code" data-language="Json"><pre class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">"icons"</span><span class="token operator">:</span> <span class="token punctuation">{</span> //定义了一些图标文件，放在images文件夹下，每个图标的名称和像素需要对应。</span>
<span class="line">        <span class="token property">"16"</span><span class="token operator">:</span> <span class="token string">"images/icon-16.png"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"32"</span><span class="token operator">:</span> <span class="token string">"images/icon-32.png"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"48"</span><span class="token operator">:</span> <span class="token string">"images/icon-48.png"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"128"</span><span class="token operator">:</span> <span class="token string">"images/icon-128.png"</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"browser_action"</span><span class="token operator">:</span> <span class="token punctuation">{</span> // browser_action指定扩展的图标放在Chrome的工具栏中</span>
<span class="line">        <span class="token property">"default_popup"</span><span class="token operator">:</span> <span class="token string">"popup.html"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"default_icon"</span><span class="token operator">:</span> <span class="token punctuation">{</span> // 定义了在工具栏中显示的图标</span>
<span class="line">            <span class="token property">"19"</span><span class="token operator">:</span> <span class="token string">"images/icon-19.png"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"38"</span><span class="token operator">:</span> <span class="token string">"images/icon-38.png"</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"manifest_version"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>//manifest的版本，这里现在填<span class="token number">2</span>就好了</span>
<span class="line">    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Kotori Music Player"</span><span class="token punctuation">,</span>//扩展的名字</span>
<span class="line">    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.4"</span><span class="token punctuation">,</span>扩展的当前版本，这里由你自己控制，以后升级的时候，要比当前版本高就好了。</span>
<span class="line">    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"调用虾米API播放选定的精选集，支持歌词同步显示。"</span><span class="token punctuation">,</span>// 对于这个拓展的描述</span>
<span class="line">    <span class="token property">"background"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"page"</span><span class="token operator">:</span> <span class="token string">"background.html"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"persistent"</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"options_page"</span><span class="token operator">:</span> <span class="token string">"options.html"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"permissions"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">"tabs"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"storage"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"notifications"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"http://*/*"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"https://*/*"</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span></pre><div class="tools"></div></figure>
<p>以上除了permissions都能根据字面意思理解，permissions属性中声明需要跨域的权限。一些API比如tabs,notifications,<br>contextMenus等都需要在permissions中声明。</p>
<p>接下来看一下background.html，主要就是放置一个audio标签，用于后台播放歌曲文件。</p>
<figure class="highlight code" data-language="Html"><pre class="language-html"><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></span>
<span class="line">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>audio</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>music<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>audio</span><span class="token punctuation">></span></span></span>
<span class="line">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>js/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="line">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>js/global.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="line">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>js/background.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></span></pre><div class="tools"></div></figure>
<p>其中主要的JavaScript脚本background.js 如下，主要包括精选集解析，歌曲解析，LRC格式歌词解析。在background处理完必要的事件后，将一些需要和前台popup交互的元素复制到变量里：</p>
<figure class="highlight code" data-language="Javascript"><pre class="language-javascript"><span class="line"><span class="token comment" spellcheck="true">//各种需要用到的变量</span></span>
<span class="line"><span class="token keyword">var</span> audio <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#music'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> item <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> isPlaying <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> currentMusic <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> prevMusic <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> repeat <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span>repeat<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> ratio <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> artist <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> cover <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> playlist <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> lyricUrl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> lyric <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> collectID <span class="token operator">=</span> <span class="token function">getCollectID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    url<span class="token punctuation">:</span> <span class="token string">'http://kotori.sinaapp.com/xiami/collect/'</span> <span class="token operator">+</span> collectID<span class="token punctuation">,</span></span>
<span class="line">    type<span class="token punctuation">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span></span>
<span class="line">    dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">    success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        playlist <span class="token operator">=</span> data<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    error<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            type<span class="token punctuation">:</span> <span class="token string">"basic"</span><span class="token punctuation">,</span></span>
<span class="line">            title<span class="token punctuation">:</span> <span class="token string">'Message'</span><span class="token punctuation">,</span></span>
<span class="line">            message<span class="token punctuation">:</span> <span class="token string">'Kotori API Error'</span><span class="token punctuation">,</span></span>
<span class="line">            iconUrl<span class="token punctuation">:</span> <span class="token string">'images/icon-128.png'</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'&lt;&lt;&lt;Kotoriの电台>>>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Version : 20150719'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Current Music: '</span> <span class="token operator">+</span> currentMusic <span class="token operator">+</span> <span class="token string">' Repeat: '</span> <span class="token operator">+</span> repeat<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> loadMusic <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    currentMusic <span class="token operator">=</span> localStorage<span class="token punctuation">.</span>currentMusic <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment" spellcheck="true">//console.log(localStorage.currentMusic);</span></span>
<span class="line">    item <span class="token operator">=</span> playlist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        type<span class="token punctuation">:</span> <span class="token string">"get"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">async</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">        dataType<span class="token punctuation">:</span> <span class="token string">"json"</span><span class="token punctuation">,</span></span>
<span class="line">        url<span class="token punctuation">:</span> <span class="token string">'https://kotori.sinaapp.com/xiami/single/'</span> <span class="token operator">+</span> item<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">        success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>url <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                src <span class="token operator">=</span> data<span class="token punctuation">.</span>url<span class="token punctuation">;</span></span>
<span class="line">                audio<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                cover <span class="token operator">=</span> data<span class="token punctuation">.</span>img<span class="token punctuation">;</span></span>
<span class="line">                artist <span class="token operator">=</span> data<span class="token punctuation">.</span>artist_name<span class="token punctuation">;</span></span>
<span class="line">                name <span class="token operator">=</span> data<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">                lyricUrl <span class="token operator">=</span> data<span class="token punctuation">.</span>lyric<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>isPlaying<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                     <span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                         type<span class="token punctuation">:</span> <span class="token string">"basic"</span><span class="token punctuation">,</span></span>
<span class="line">                         title<span class="token punctuation">:</span> name<span class="token punctuation">,</span></span>
<span class="line">                         message<span class="token punctuation">:</span> artist<span class="token punctuation">,</span></span>
<span class="line">                         iconUrl<span class="token punctuation">:</span> cover</span>
<span class="line">                     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Song Title: '</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' Song Artist: '</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>artist_name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">                <span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    type<span class="token punctuation">:</span> <span class="token string">"basic"</span><span class="token punctuation">,</span></span>
<span class="line">                    title<span class="token punctuation">:</span> <span class="token string">'Message'</span><span class="token punctuation">,</span></span>
<span class="line">                    message<span class="token punctuation">:</span> <span class="token string">'歌曲获取失败，请重试。'</span><span class="token punctuation">,</span></span>
<span class="line">                    iconUrl<span class="token punctuation">:</span> <span class="token string">'images/icon-128.png'</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> changeMusic <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">loadMusic</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> randomNum <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>min <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> autoChange <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> nextMusic <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>repeat<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span></span>
<span class="line">            prevMusic <span class="token operator">=</span> currentMusic<span class="token punctuation">;</span></span>
<span class="line">            nextMusic <span class="token operator">=</span> <span class="token function">randomNum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> playlist<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">changeMusic</span><span class="token punctuation">(</span>nextMusic<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span></span>
<span class="line">            audio<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMusic <span class="token operator">==</span> playlist<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">changeMusic</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">changeMusic</span><span class="token punctuation">(</span>currentMusic <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> updateProgress <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>audio<span class="token punctuation">.</span>currentTime <span class="token operator">==</span> audio<span class="token punctuation">.</span>duration<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment" spellcheck="true">//autoChange();</span></span>
<span class="line">        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    ratio <span class="token operator">=</span> audio<span class="token punctuation">.</span>currentTime <span class="token operator">/</span> audio<span class="token punctuation">.</span>duration <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> getLyric <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>lyricUrl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        url<span class="token punctuation">:</span> lyricUrl<span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span></span>
<span class="line">        dataType<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">async</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">        success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            lyric <span class="token operator">=</span> <span class="token function">parseLyric</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        error<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                type<span class="token punctuation">:</span> <span class="token string">"basic"</span><span class="token punctuation">,</span></span>
<span class="line">                title<span class="token punctuation">:</span> <span class="token string">'Message'</span><span class="token punctuation">,</span></span>
<span class="line">                message<span class="token punctuation">:</span> <span class="token string">'Lyric Fetch Error'</span><span class="token punctuation">,</span></span>
<span class="line">                iconUrl<span class="token punctuation">:</span> <span class="token string">'images/icon-128.png'</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> parseLyric <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment" spellcheck="true">//get each line from the text</span></span>
<span class="line">    <span class="token keyword">var</span> lines <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token comment" spellcheck="true">//this regex mathes the time [00.12.78]</span></span>
<span class="line">        pattern <span class="token operator">=</span> <span class="token regex">/\[\d{2}:\d{2}.\d{2}\]/g</span><span class="token punctuation">,</span></span>
<span class="line">        result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment" spellcheck="true">// Get offset from lyrics</span></span>
<span class="line">    <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token function">getOffset</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment" spellcheck="true">//exclude the description parts or empty parts of the lyric</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        lines <span class="token operator">=</span> lines<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment" spellcheck="true">//remove the last empty item</span></span>
<span class="line">    lines<span class="token punctuation">[</span>lines<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lines<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment" spellcheck="true">//display all content on the page</span></span>
<span class="line">    lines<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> i<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> time <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            value <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        time<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> i1<span class="token punctuation">,</span> a1<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment" spellcheck="true">//convert the [min:sec] to secs format then store into result</span></span>
<span class="line">            <span class="token keyword">var</span> t <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">parseInt</span><span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">+</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment" spellcheck="true">//sort the result by time</span></span>
<span class="line">    result<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> getOffset <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment" spellcheck="true">//Returns offset in miliseconds.</span></span>
<span class="line">    <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment" spellcheck="true">// Pattern matches [offset:1000]</span></span>
<span class="line">        <span class="token keyword">var</span> offsetPattern <span class="token operator">=</span> <span class="token regex">/\[offset:\-?\+?\d+\]/g</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token comment" spellcheck="true">// Get only the first match.</span></span>
<span class="line">            offset_line <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>offsetPattern<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token comment" spellcheck="true">// Get the second part of the offset.</span></span>
<span class="line">            offset_str <span class="token operator">=</span> offset_line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment" spellcheck="true">// Convert it to Int.</span></span>
<span class="line">        offset <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>offset_str<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment" spellcheck="true">//alert("offset error: "+err.message);</span></span>
<span class="line">        offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> offset<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> play <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    audio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">getLyric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    timeout <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span>updateProgress<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment" spellcheck="true">//setInterval(showLyric, 1000);</span></span>
<span class="line">    isPlaying <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> pause <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    audio<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">clearInterval</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    isPlaying <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> next <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>repeat <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        prevMusic <span class="token operator">=</span> currentMusic<span class="token punctuation">;</span></span>
<span class="line">        nextMusic <span class="token operator">=</span> <span class="token function">randomNum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> playlist<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">changeMusic</span><span class="token punctuation">(</span>nextMusic<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMusic <span class="token operator">==</span> playlist<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">changeMusic</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">changeMusic</span><span class="token punctuation">(</span>currentMusic <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> previous <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>repeat <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> prevMusic <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">changeMusic</span><span class="token punctuation">(</span>prevMusic<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        prevMusic <span class="token operator">=</span> <span class="token function">randomNum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> playlist<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMusic <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">changeMusic</span><span class="token punctuation">(</span>playlist<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">changeMusic</span><span class="token punctuation">(</span>currentMusic <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment" spellcheck="true">//初始化操作</span></span>
<span class="line"><span class="token function">loadMusic</span><span class="token punctuation">(</span>currentMusic<span class="token punctuation">)</span><span class="token punctuation">;</span></span></pre><div class="tools"></div></figure>
<p>关于LRC歌词文件，一般格式如下：</p>
<pre><code>[ar:文筱芮]
[by:airplay]
[00:00.00]那个
[00:03.00]作词:文筱芮 作曲:文筱芮
[00:06.00]编曲:于韵非
[00:09.00]制作人:胡海泉 秦天
[00:12.00]演唱:文筱芮</code></pre><p>这样挺有规律的，用正则可以很方便地将时间与歌词提取分离。</p>
<p>但凡事得多个心眼啊。事后发生的事情证明这句话有多正确。我在整理歌词时还发现了另外一种形式，像下面这样：</p>
<pre><code>[ar:庭竹]
[al:爱的九宫格]
[by:airplay]
[00:00.17]庭竹 - 公主的天堂
[00:05.40]作曲:陈嘉唯、Skot Suyama 陶山、庭竹
[00:07.33]作词:庭竹
[00:15.59]风铃的音谱 在耳边打转
[00:18.62]城堡里 公主也摆脱了黑暗的囚禁
[00:22.82]她一点点地 无声悄悄地慢慢长大
[00:26.36]期待着 深锁木门后的世界
[01:38.72][00:29.76]
[01:51.48][00:30.32]树上 小鸟的轻响 在身边打转
[01:55.35][00:34.09]公主已 忘记木制衣橱背后的惆怅
[01:59.65][00:38.35]她跳舞唱歌天真无邪地寻找属于自己的光亮和快乐
[02:06.98][00:45.76]
[02:07.41][00:46.06]树叶一层层拨开了伪装
[02:11.29][00:50.25]彩虹一步步露出美丽脸庞 无限的光亮</code></pre><p>这种形式的歌词把歌词内容相同但时间不同的部分合并，节省了篇幅。</p>
<p>所以，现在知道的歌词其实有两种写法了，不过都还算规律，用正则可以搞定，只是对于第二种，处理时得将时间再次分割。</p>
<p>JavaScript解析法上面已经给出，本扩展最开始采用的是PHP解析成JSON格式，但是试过效率并不高，代码如下：</p>
<figure class="highlight code" data-language="Php"><pre class="language-php"><span class="line"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">parseLyric</span><span class="token punctuation">(</span><span class="token variable">$lyric</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$lyric</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment" spellcheck="true">// 远程获取歌词内容</span></span>
<span class="line">            <span class="token variable">$content</span> <span class="token operator">=</span> @<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$lyric</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment" spellcheck="true">// 按”回车换行“将歌词切割成数组</span></span>
<span class="line">            <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token variable">$lrc</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$array</span> <span class="token keyword">as</span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment" spellcheck="true">// 清除掉”回车不换行“符号</span></span>
<span class="line">                <span class="token variable">$val</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">'/\r/'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment" spellcheck="true">// 正则匹配歌词时间</span></span>
<span class="line">                <span class="token variable">$temp</span> <span class="token operator">=</span> <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token string">'/\[\d{2}\:\d{2}\.\d{2}\]/'</span><span class="token punctuation">,</span> <span class="token variable">$val</span><span class="token punctuation">,</span> <span class="token variable">$matches</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$matches</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token variable">$data_plus</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token variable">$time_array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                    <span class="token comment" spellcheck="true">// 将可能匹配的多个时间挑选出来，例如：[00:21]、[03:40]</span></span>
<span class="line">                    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$matches</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$V</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token variable">$data_plus</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$V</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token variable">$V</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token variable">$V</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token variable">$V</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"]"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token variable">$V</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token variable">$date_array</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">,</span> <span class="token variable">$V</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                        <span class="token comment" spellcheck="true">// 将例如：00:21、03:40 转换成秒</span></span>
<span class="line">                        <span class="token variable">$time_array</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$date_array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$date_array</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                    <span class="token comment" spellcheck="true">// 将上面的得到的时间，例如：[00:21][03:40]，替换成空，得到歌词</span></span>
<span class="line">                    <span class="token variable">$data_plus</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token variable">$data_plus</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                    <span class="token comment" spellcheck="true">// 将时间和歌词组合到数组中</span></span>
<span class="line">                    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$time_array</span> <span class="token keyword">as</span> <span class="token variable">$V</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token comment" spellcheck="true">//$lrc[] = array($V, $data_plus);</span></span>
<span class="line">                        <span class="token variable">$lrc</span><span class="token punctuation">[</span><span class="token string">'time'</span> <span class="token punctuation">.</span> <span class="token variable">$V</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$data_plus</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment" spellcheck="true">// 按时间顺序来排序数组</span></span>
<span class="line">            <span class="token comment" spellcheck="true">//$lrc = $this->bsort($lrc);</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment" spellcheck="true">// 输出 json格式</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$lrc</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">'no lyric'</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">bsort</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$array</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token variable">$count</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$count</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token variable">$count</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$j</span> <span class="token operator">></span> <span class="token variable">$i</span><span class="token punctuation">;</span> <span class="token variable">$j</span><span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">[</span><span class="token variable">$j</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token variable">$j</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token variable">$temp</span> <span class="token operator">=</span> <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token variable">$j</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token variable">$j</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token variable">$j</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token variable">$j</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$temp</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token variable">$array</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span></pre><div class="tools"></div></figure>
<p>下面看一下popup.html文件的内容，该页面主要就是播放器和播放列表。</p>
<figure class="highlight code" data-language="Html"><pre class="language-html"><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>css/popup.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>popup<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>nav_buttons<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>breadcrumb-part<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tab-text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>正在播放<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>搜索播放列表...<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>loadingOverlay<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>regularLoadingOverlay<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>close_nav<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Click to close navigation<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>X<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navigate<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>player<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>album_art<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>big_art<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>album_art_img<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>../images/default_album_med.png<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>128<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>128<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>song_indicator<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>song_info<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>song_title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>artist<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>lyric<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>time_and_slider<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>player-middle<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>goog-slider-horizontal goog-slider-track<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span> <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playing-progress-background<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>played_slider<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>goog-slider-thumb<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">top</span><span class="token punctuation">:</span> <span class="token number">21</span>px<span class="token punctuation">;</span> <span class="token property">left</span><span class="token punctuation">:</span> <span class="token number">15</span>px<span class="token punctuation">;</span> <span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>time<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>current_time<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0:00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span> / <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>total_time<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0:00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>controls<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rew<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>goog-flat-button goog-inline-block<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Previous song<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">-webkit-user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> </span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playPause<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>goog-flat-button goog-inline-block<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Play<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">-webkit-user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> </span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ff<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>goog-flat-button goog-inline-block<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Next song<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">-webkit-user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span> </span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line"></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>js/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>js/popup.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></span></pre><div class="tools"></div></figure>
<p>这里的js文件主要就是控制background页面中的audio标签，就不给出篇幅了。<br>关键一句就是<code>var bg = chrome.extension.getBackgroundPage();</code><br>通过bg.xx就可以调用background中的变量和方法。</p>
<p>歌词同步的具体思路：</p>
<ul>
<li>首先将LRC文件读取为文本</li>
<li>用String.prototype.split(‘\n’);将整个文本以换行符为单位分隔成一行一行的文本，保存到一个数组中</li>
<li>然后将开头部分不属于歌词的文本去掉，得到只有时间与歌词的干净文件</li>
<li>对于每一行，匹配出时间与文字，分别存入数组[time,text]，然后将每行得到的这样的数组存入一个大的数组[[time,text],[time,text]…]</li>
<li>利用Audio标签的ontimeupdate事件，不断比较当然播放时间audio.currentTime与数组中每个元素中时间，如果当前时间大于某个歌词中的时间，则显示该歌词</li>
</ul>
<p>到这里本文就基本结束了，以后再补充好了233333</p>
<h3 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h3><p><a href="https://github.com/kokororin/KotoriMusicPlayer" target="_blank" rel="noopener">GitHub</a></p>
<h3 id="安装地址"><a href="#安装地址" class="headerlink" title="安装地址"></a>安装地址</h3><p><a href="https://chrome.google.com/webstore/detail/jfibodpknfkelhgncgbicgoeifilampg" target="_blank" rel="noopener">Chrome Web Store</a></p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a href="https://crxdoc-zh.appspot.com/extensions/getstarted" target="_blank" rel="noopener">入门：建立 Chrome 扩展程序</a><br><a href="https://crxdoc-zh.appspot.com/extensions/tabs" target="_blank" rel="noopener">chrome.tabs</a><br><a href="http://www.zhihu.com/question/20179805" target="_blank" rel="noopener">如何从零开始写一个 Chrome 扩展？</a><br><a href="https://developer.chrome.com/extensions/getstarted" target="_blank" rel="noopener">官方入门文档</a><br><a href="http://www.w3ctech.com/topic/283" target="_blank" rel="noopener">Chrome 扩展开发笔记</a><br><a href="http://www.cnblogs.com/Wayou/p/sync_lyric_with_html5_audio.html" target="_blank" rel="noopener">论HTML5 Audio 标签歌词同步的实现</a></p>

      </div>
    </article>
  </div>

  <center>
    <div id="postnav" style="display: none;">
      <ul class="pager">
        <li class="previous">
          <a href="http://kotori.love">
            <span class="fui-home"></span>
          </a>
        </li>
        <li class="next" id="outcomment">
          <a href="javascript:void(0)">
            <span class="fui-chat"></span>
          </a>
        </li>

        <li class="previous">
          
          <a href="http://kotori.love/archives/install-nginx-php-mysql-on-osx.html" title="OS X下配置Nginx+PHP+MySQL">OS X下配置Nginx+PHP+MySQL</a>
          
        </li>

        <li class="next">
          
          <a href="http://kotori.love/archives/download-baiduyun-with-aria2.html" title="使用aria2黑科技高速下载百度等网盘文件">使用aria2黑科技高速下载百度等网盘文件</a>
          
        </li>
      </ul>
    </div>
  </center>

  <div id="comments"></div>
  <div id="disqus_thread"></div>

  <!-- <div class="post-tor-content">
    <div class="post-tor" id="postTor" style="display: none;">
      <div class="torarc-t">
        <div class="torarc-tile">
        </div>
      </div>
    </div>
  </div> -->

</div>

<!-- Disqus 用于评论系统 -->

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'http://kotori.love/archives/chrome-extension-notes.html';  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = 'http://kotori.love/archives/chrome-extension-notes.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  }
  var d = document;
  var s = d.createElement('script');
  s.src = '//sora-diary.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
</script>


  <footer id="footer" class="container" style="background:rgba(255, 255, 255, 0);display:none;">
  <hr>
  <div style="text-align:center;padding-bottom:9px;">
    <p>&copy; 2020 <a href="http://kotori.love">ことりのおやつにしてやるぞー！</a>.
      Using <a target="_blank" href="https://hexo.io/">Hexo</a> & <a target="_blank"
        href="https://yumoe.com">Moricolor</a>
      / <a href="/atom.xml">RSS</a>
  </div>
</footer>

<!-- jQuery (necessary for Flat UI's JavaScript plugins) -->

<script src="/js/vendor/jquery.min.js"></script>


<script src="/js/zoom-js/js/zoom.js"></script>


<script src="/js/vendor/bootstrap.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<!-- 
<script src="/js/vendor/video.js"></script>
 -->

<script src="/js/flat-ui.min.js"></script>


<script src="/js/prism.js"></script>


<script type="text/javascript">
  function getHitokoto() {
    $.ajax({ url: "https://api.imjad.cn/hitokoto/" }).then(function (response) {
      $("#hitokoto").html("Hitokoto&nbsp; · &nbsp;&nbsp;" + response);
    });
  }

  $(document).ready(function () {
    $("#main-index").fadeIn(800);
    $("#main-archive").fadeIn(800);
    $("#main-post").fadeIn(500);
    $("#postnav").fadeIn(800);
    $("#main-page").fadeIn(500);
    $("#pagenav").fadeIn(800);
    $("#bottomtools").fadeIn(1200);
    if (window.location.hash != '') {
      var i = window.location.hash.indexOf('#comment');
      var ii = window.location.hash.indexOf('#respond-post');
      if (i != '-1' || ii != '-1') {
        $("#comments").fadeIn(1000);
      }
    }
    $("#thatsi").fadeIn(1300);
    $("#footer").css('display', 'block');
    
      // 锚点平滑滚动
      $('a[href*=#],area[href*=#]').click(function () {
        $body = (window.opera) ? (document.compatMode == "CSS1Compat" ? $('html') : $('body')) : $('html,body'); //Opera BUG fixed
        if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') && location.hostname == this.hostname && location.search == this.search) {
          var $target = $(this.hash);
          $target = $target.length && $target || $('[name=' + this.hash.slice(1) + ']');
          if ($target.length) {
            var targetOffset = $target.offset().top;
            $('html,body').animate({
              scrollTop: targetOffset
            },
              1000);
            return false;
          }
        }
      });
    // end
    
  });

  $("#outcomment").click(function () {
    $("#comments").fadeIn(1000);
  });

  $("#comment_go").click(function () {
    $("#comments").fadeIn(1000);
  });

  $("#tor_show").click(function () {
    if ($("#postTor").css('display') == 'none;') {
      $("#postTor").fadeIn(400);
      $("#postTor").css('display', 'inline-block');
    } else {
      $("#postTor").fadeOut(400);
    }
  });
</script>
<script>
  $(function () {
    $('[data-toggle=tooltip]').tooltip();
  });
</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70944432-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70944432-1');
</script>

</body>
</html>
